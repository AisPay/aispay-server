import {hashSync} from "bcrypt";
import {RoleModel} from "../models/role.model";
import {UserModel} from "../models/user.model";
import {logger} from "../utils/logger";
import {env} from "./env";

export const init = async () => {
  logger.info("???????? ?????");

  let roleCandidate = await RoleModel.findOne({search: [{key: "name", value: "admin"}]});
  if (!roleCandidate) {
    logger.info(`???????? ???? "admin"`);
    await RoleModel.add({name: "admin", description: "?????? ? ????? ???????", functions: ["main", "users", "roles", "transactions"]});
  } else logger.warn('???? "admin" ??? ??????????');

  roleCandidate = await RoleModel.findOne({search: [{key: "name", value: "trader"}]});
  if (!roleCandidate) {
    logger.info(`???????? ???? "trader"`);
    await RoleModel.add({name: "trader", description: "?????? ?? ????????", functions: ["main"]});
  } else logger.warn('???? "trader" ??? ??????????');

  roleCandidate = await RoleModel.findOne({search: [{key: "name", value: "partner"}]});
  if (!roleCandidate) {
    logger.info(`???????? ???? "partner"`);
    await RoleModel.add({name: "partner", description: "?????????????? ??????", functions: ["main"]});
  } else logger.warn('???? "partner" ??? ??????????');

  roleCandidate = await RoleModel.findOne({search: [{key: "name", value: "operator"}]});
  if (!roleCandidate) {
    logger.info(`???????? ???? "operator"`);
    await RoleModel.add({name: "operator", description: "?????? ?? ???????", functions: ["main"]});
  } else logger.warn('???? "operator" ??? ??????????');

  let candidate = await UserModel.findOne({search: [{key: "login", value: env.INIT_ADMIN_LOGIN}]});
  if (!candidate) {
    logger.info(`???????? ???????????? "${env.INIT_ADMIN_LOGIN}"(admin)`);
    let roleAdmin = await RoleModel.findOne({search: [{key: "name", value: "admin"}]});
    await UserModel.add({login: env.INIT_ADMIN_LOGIN, passwordHash: hashSync(env.INIT_ADMIN_PASSWORD, env.SALT_ROUND), roleId: roleAdmin!.id});
  } else logger.warn(`???????????? "${env.INIT_ADMIN_LOGIN}"(admin) ??? ??????????`);

  candidate = await UserModel.findOne({search: [{key: "login", value: env.INIT_TRADER_LOGIN}]});
  if (!candidate) {
    logger.info(`???????? ???????????? "${env.INIT_TRADER_LOGIN}"(trader)`);
    let roleAdmin = await RoleModel.findOne({search: [{key: "name", value: "trader"}]});
    await UserModel.add({login: env.INIT_TRADER_LOGIN, passwordHash: hashSync(env.INIT_TRADER_PASSWORD, env.SALT_ROUND), roleId: roleAdmin!.id});
  } else logger.warn(`???????????? "${env.INIT_TRADER_LOGIN}"(trader) ??? ??????????`);

  candidate = await UserModel.findOne({search: [{key: "login", value: env.INIT_PARTNER_LOGIN}]});
  if (!candidate) {
    logger.info(`???????? ???????????? "${env.INIT_PARTNER_LOGIN}"(partner)`);
    let roleAdmin = await RoleModel.findOne({search: [{key: "name", value: "partner"}]});
    await UserModel.add({login: env.INIT_PARTNER_LOGIN, passwordHash: hashSync(env.INIT_PARTNER_PASSWORD, env.SALT_ROUND), roleId: roleAdmin!.id});
  } else logger.warn(`???????????? "${env.INIT_PARTNER_LOGIN}"(partner) ??? ??????????`);

  candidate = await UserModel.findOne({search: [{key: "login", value: env.INIT_OPERATOR_LOGIN}]});
  if (!candidate) {
    logger.info(`???????? ???????????? "${env.INIT_OPERATOR_LOGIN}"(partner)`);
    let roleAdmin = await RoleModel.findOne({search: [{key: "name", value: "partner"}]});
    await UserModel.add({login: env.INIT_OPERATOR_LOGIN, passwordHash: hashSync(env.INIT_OPERATOR_PASSWORD, env.SALT_ROUND), roleId: roleAdmin!.id});
  } else logger.warn(`???????????? "${env.INIT_OPERATOR_LOGIN}"(partner) ??? ??????????`);
};
